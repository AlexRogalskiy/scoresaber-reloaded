import queue from '../network/queues';
import {PRIORITY} from '../network/http-queue';
import log from '../utils/logger'
import beatSaviorPlayersRepository from '../db/repository/beat-savior-players'
import {addToDate, MINUTE} from '../utils/date'

const MAIN_PLAYER_REFRESH_INTERVAL = MINUTE * 10;

export default () => {
    // TODO: actual caching in IndexedDB; remove it!
    let cache = [
      {"_id":"60b52ed254c6370022f92bab","songDataType":1,"playerID":"76561198035381239","songID":"9F004C943E5CB3B007E93B148C6DA9ADF1280765","songDifficulty":"expert","songName":"YELL!","songArtist":"DJ Genki VS Camellia","songMapper":"Joshabi","songSpeed":1,"songStartTime":0,"songDuration":309.054,"trackers":{"hitTracker":{"leftNoteHit":862,"rightNoteHit":882,"bombHit":0,"maxCombo":1065,"nbOfWallHit":0,"miss":3,"missedNotes":3,"badCuts":0,"leftMiss":0,"leftBadCuts":0,"rightMiss":3,"rightBadCuts":0},"accuracyTracker":{"accRight":109.480728,"accLeft":108.755219,"averageAcc":109.122131,"leftSpeed":30.5651,"rightSpeed":35.2272758,"averageSpeed":32.92292,"leftHighestSpeed":52.80823,"rightHighestSpeed":68.07909,"leftPreswing":1.35652733,"rightPreswing":1.40345454,"averagePreswing":1.38026,"leftPostswing":1.87026989,"rightPostswing":1.94784248,"averagePostswing":1.909501,"leftTimeDependence":0.1974086,"rightTimeDependence":0.285293877,"averageTimeDependence":0.241855159,"leftAverageCut":[69.82947,8.940835,29.9849186],"rightAverageCut":[69.89116,9.606576,29.9829941],"averageCut":[69.8606644,9.277523,29.9839458],"gridAcc":[107.701752,110.194443,110.23848,106.919357,107.746033,107.625,110.375,108.303848,108.415581,109.64151,109.244896,108.758621],"gridCut":[57,360,369,62,252,8,8,260,77,106,98,87]},"scoreTracker":{"rawScore":1506366,"score":1506366,"personalBest":0,"rawRatio":0.9414817,"modifiedRatio":0.9414817,"personalBestRawRatio":0,"personalBestModifiedRatio":0,"modifiersMultiplier":1,"modifiers":[]},"winTracker":{"won":true,"rank":"SS","endTime":308.8661,"nbOfPause":0},"distanceTracker":{"rightSaber":1335.27454,"leftSaber":4957.29932,"rightHand":1335.27454,"leftHand":1298.69824},"scoreGraphTracker":{"graph":{"2":0.991304338,"3":0.9777778,"4":0.9679319,"5":0.964844346,"6":0.962203443,"7":0.955090642,"8":0.9528976,"9":0.952479959,"10":0.9509382,"11":0.9501194,"12":0.949121058,"13":0.9490547,"14":0.9508175,"15":0.9523821,"16":0.9539134,"17":0.9548202,"18":0.9554336,"19":0.9559542,"20":0.9565672,"21":0.9575522,"24":0.9585688,"25":0.959453762,"27":0.960124,"28":0.960522,"29":0.960756063,"30":0.9609519,"31":0.961087644,"32":0.9612499,"33":0.9614944,"34":0.9617492,"35":0.9620388,"36":0.9624019,"37":0.9625365,"38":0.962634444,"39":0.962695956,"41":0.962727,"42":0.962741852,"44":0.962756455,"45":0.962704539,"46":0.9625966,"47":0.9625411,"48":0.962252259,"49":0.9619369,"50":0.96163553,"51":0.961159348,"52":0.9605624,"53":0.9600764,"54":0.959776044,"55":0.9593505,"56":0.9588552,"57":0.9584188,"58":0.957985,"59":0.9574768,"60":0.956973851,"61":0.9567362,"62":0.9565485,"63":0.9564154,"64":0.9562976,"65":0.956046641,"66":0.955851,"67":0.9556051,"68":0.9555009,"69":0.955412447,"70":0.9557493,"71":0.9560274,"72":0.956350267,"73":0.956609368,"74":0.956836343,"75":0.9570104,"76":0.9570642,"77":0.9570984,"78":0.957166135,"79":0.957259953,"80":0.9572938,"81":0.9574417,"82":0.9575772,"83":0.9576755,"84":0.9576633,"85":0.957677543,"86":0.9576493,"87":0.9575942,"88":0.9575181,"89":0.9575215,"90":0.957427263,"91":0.957249761,"92":0.956976,"93":0.9567294,"94":0.9565477,"95":0.9564099,"96":0.956205964,"97":0.956090152,"98":0.9559075,"99":0.9556924,"100":0.9554609,"101":0.955379844,"102":0.955299854,"103":0.9552627,"104":0.9552448,"105":0.955190837,"106":0.955177367,"107":0.9550616,"108":0.9548712,"109":0.9546459,"110":0.9545227,"111":0.954370141,"112":0.9543312,"113":0.9543309,"114":0.9542867,"115":0.9542512,"116":0.954193354,"117":0.954085648,"118":0.953992665,"119":0.9539733,"120":0.9538732,"121":0.9537501,"122":0.9536415,"123":0.9535412,"124":0.95336175,"125":0.9531869,"126":0.9530135,"127":0.9528977,"128":0.952816844,"129":0.9527865,"130":0.952727735,"131":0.95268625,"132":0.9526441,"133":0.9525881,"134":0.9525641,"135":0.9525671,"136":0.9525307,"137":0.9524728,"138":0.9522541,"139":0.9519653,"140":0.9517547,"141":0.95159924,"142":0.951375,"143":0.9512594,"144":0.95121026,"145":0.951075733,"146":0.950949669,"147":0.9508527,"148":0.950766444,"149":0.9506407,"150":0.950489,"151":0.95037204,"152":0.9502835,"153":0.950208664,"154":0.9500779,"155":0.9500195,"156":0.949959755,"157":0.9499197,"158":0.9499324,"159":0.9499994,"160":0.950060546,"161":0.950085342,"162":0.9500986,"163":0.950015068,"164":0.9499509,"165":0.949882567,"166":0.9498056,"167":0.949698567,"168":0.9496849,"169":0.9496696,"170":0.949637234,"171":0.949587047,"172":0.9495726,"173":0.9494611,"174":0.9493539,"175":0.949227154,"176":0.9491526,"177":0.94901,"178":0.94896394,"179":0.948940933,"180":0.948943853,"181":0.9489403,"182":0.949018836,"183":0.949080348,"184":0.9491351,"185":0.9491864,"186":0.9492105,"187":0.9492089,"188":0.9492007,"189":0.949180543,"190":0.9491737,"191":0.949193358,"192":0.9492317,"193":0.9492649,"194":0.949314535,"195":0.94936204,"196":0.9494078,"197":0.9491896,"198":0.948789835,"199":0.9482786,"200":0.9474948,"201":0.946707845,"202":0.9461926,"203":0.945870042,"204":0.9456507,"205":0.9456938,"206":0.9457104,"207":0.9456973,"208":0.945715666,"209":0.945773065,"210":0.9458459,"211":0.9459587,"212":0.946100235,"213":0.9462157,"214":0.9462851,"215":0.9463663,"216":0.946377754,"217":0.9463717,"218":0.946362555,"219":0.9463537,"220":0.946323752,"221":0.9463259,"222":0.9463471,"223":0.94633925,"224":0.9463643,"225":0.946393,"226":0.946416,"227":0.9464092,"228":0.9464315,"229":0.9464284,"230":0.946407259,"231":0.9464034,"232":0.9464306,"233":0.946444333,"234":0.9464158,"235":0.9463828,"236":0.9462949,"237":0.9461646,"238":0.9460256,"239":0.9458935,"240":0.9457671,"241":0.9456991,"242":0.945666134,"243":0.945655048,"244":0.945673168,"245":0.945710838,"246":0.945755363,"247":0.945806742,"248":0.9458397,"249":0.945857763,"250":0.9458542,"251":0.9458074,"252":0.9453143,"253":0.944713235,"254":0.9441034,"255":0.9435072,"256":0.9429369,"257":0.942807436,"258":0.9427858,"259":0.942775965,"260":0.9427842,"261":0.942777,"262":0.942744255,"263":0.9427209,"264":0.9427165,"265":0.942696,"266":0.9426994,"267":0.9427299,"268":0.9422377,"269":0.9417259,"270":0.9412164,"271":0.940673649,"272":0.940146863,"273":0.940155566,"274":0.940177739,"275":0.9401977,"276":0.9402604,"277":0.940309167,"278":0.940352857,"279":0.9404079,"280":0.9404741,"281":0.9405359,"282":0.9405976,"283":0.9406641,"284":0.940719247,"285":0.940785348,"286":0.940847,"287":0.9409132,"288":0.9409691,"289":0.9410281,"290":0.9410906,"291":0.941162169,"292":0.941229343}}},"deepTrackers":null,"timeSet":"2021-05-31T18:45:38.644Z"},{"_id":"60b53dde54c6370022f9393f","songDataType":1,"playerID":"76561198035381239","songID":"FD58B27E3EE2D176211C7F53D4A4122CC378AA6C","songDifficulty":"expertplus","songName":"ALONE","songArtist":"MY FIRST STORY","songMapper":"muffn & SimplyMarvellous","songSpeed":1,"songStartTime":0,"songDuration":213.379,"trackers":{"hitTracker":{"leftNoteHit":728,"rightNoteHit":728,"bombHit":0,"maxCombo":957,"nbOfWallHit":0,"miss":5,"missedNotes":2,"badCuts":3,"leftMiss":1,"leftBadCuts":2,"rightMiss":1,"rightBadCuts":1},"accuracyTracker":{"accRight":108.188187,"accLeft":106.164833,"averageAcc":107.176514,"leftSpeed":35.10266,"rightSpeed":41.16129,"averageSpeed":38.1319771,"leftHighestSpeed":63.17782,"rightHighestSpeed":73.00495,"leftPreswing":1.33796871,"rightPreswing":1.39095986,"averagePreswing":1.36446428,"leftPostswing":1.78477776,"rightPostswing":1.83314025,"averagePostswing":1.808959,"leftTimeDependence":0.204317078,"rightTimeDependence":0.235337377,"averageTimeDependence":0.2198272,"leftAverageCut":[69.12088,7.372253,29.6717033],"rightAverageCut":[69.47665,8.942307,29.76923],"averageCut":[69.29877,8.15728,29.7204666],"gridAcc":[105.032784,107.9874,108.284554,106.579712,105.22995,108.486488,109.14286,108.082924,107.53933,105.294739,106.382111,107.635292],"gridCut":[61,238,246,69,187,37,21,205,89,95,123,85]},"scoreTracker":{"rawScore":1226530,"score":1226530,"personalBest":0,"rawRatio":0.9174605,"modifiedRatio":0.9174605,"personalBestRawRatio":0,"personalBestModifiedRatio":0,"modifiersMultiplier":1,"modifiers":[]},"winTracker":{"won":true,"rank":"SS","endTime":213.187134,"nbOfPause":0},"distanceTracker":{"rightSaber":987.592041,"leftSaber":3861.33228,"rightHand":987.592041,"leftHand":968.496643},"scoreGraphTracker":{"graph":{"5":0.973913,"6":0.9703325,"7":0.9561142,"8":0.9487013,"9":0.945519865,"10":0.9389956,"11":0.9350945,"12":0.9382106,"14":0.9410117,"15":0.9414422,"16":0.939950645,"17":0.937039435,"18":0.934806466,"19":0.9329164,"20":0.9315582,"21":0.9304329,"22":0.9289975,"23":0.927468657,"24":0.9264032,"25":0.919914067,"26":0.9137876,"27":0.908518851,"28":0.903896,"29":0.899358,"30":0.9011837,"31":0.902950943,"32":0.9044773,"33":0.9057046,"34":0.9066512,"35":0.9043688,"36":0.900408268,"37":0.8965985,"38":0.892939,"39":0.88935256,"40":0.88906455,"41":0.8904607,"42":0.891864955,"43":0.893210351,"44":0.8947294,"45":0.8961079,"46":0.8976167,"47":0.89910537,"48":0.9004422,"49":0.901643,"50":0.902658045,"51":0.9032907,"52":0.9039282,"53":0.904611766,"54":0.9054302,"55":0.906266,"56":0.9071076,"57":0.9079487,"58":0.9089042,"59":0.909575462,"60":0.91005373,"61":0.910492,"62":0.91079855,"63":0.909926,"64":0.907976031,"65":0.9062359,"66":0.904641747,"67":0.9029876,"68":0.9024323,"69":0.902947247,"70":0.903363466,"71":0.9037417,"72":0.904066145,"73":0.9042999,"74":0.9028726,"75":0.9014217,"76":0.8999816,"77":0.8987812,"78":0.897618949,"79":0.8981617,"80":0.8987559,"81":0.8992788,"82":0.8996779,"83":0.9000926,"84":0.9005499,"85":0.9010154,"86":0.9014443,"87":0.901809335,"88":0.902156353,"89":0.902563155,"90":0.9029289,"91":0.9032964,"92":0.903720856,"93":0.904126167,"94":0.9044668,"95":0.9048493,"96":0.9052585,"97":0.9056829,"98":0.9061024,"100":0.9064819,"101":0.9067876,"102":0.907072961,"103":0.907334745,"104":0.9075915,"105":0.9078267,"106":0.9081103,"107":0.908402264,"108":0.908655643,"109":0.908925653,"110":0.909195065,"111":0.9094208,"112":0.909599662,"113":0.9097686,"114":0.9099036,"115":0.9100659,"116":0.910248637,"117":0.910472035,"118":0.9107238,"119":0.91094,"120":0.9110809,"121":0.9111896,"122":0.9112937,"123":0.911353,"124":0.911519468,"125":0.911725461,"126":0.9119399,"127":0.912169755,"128":0.91243726,"129":0.9124931,"130":0.9125348,"131":0.912609756,"132":0.9126528,"133":0.9126507,"134":0.9127549,"135":0.9129173,"136":0.9130461,"137":0.9131511,"138":0.913255155,"139":0.9133732,"140":0.9134549,"141":0.9135928,"142":0.9137896,"143":0.913995147,"144":0.9142089,"145":0.9144254,"146":0.9146281,"147":0.9148127,"148":0.915028751,"149":0.91520077,"150":0.9153568,"151":0.915463865,"152":0.915575,"153":0.9156548,"154":0.9157949,"155":0.9159017,"156":0.916022539,"157":0.91611737,"158":0.916214,"159":0.916294456,"160":0.9164336,"161":0.9165896,"162":0.9167105,"163":0.9168422,"164":0.9169378,"165":0.91700083,"166":0.917046845,"167":0.917166233,"168":0.917218149,"169":0.917288542,"170":0.9173274,"171":0.9173654,"172":0.9173259,"173":0.917320549,"177":0.917308152,"180":0.9173341,"181":0.9173553,"182":0.917388856,"183":0.917442,"184":0.91749835,"185":0.917554438,"186":0.917610943,"187":0.9176935,"188":0.917789757,"189":0.917880237,"190":0.917988241,"191":0.9180881,"192":0.9181868,"193":0.918273449,"194":0.9183508,"195":0.9184419,"196":0.918548048,"197":0.918660045,"198":0.918767869,"199":0.918878734,"200":0.9189846,"201":0.919059038,"202":0.9191301,"203":0.9192138,"204":0.9193225,"205":0.9193963,"206":0.9195015,"207":0.919457436,"208":0.919075251,"209":0.9185679,"210":0.9180743,"211":0.9176034}}},"deepTrackers":null,"timeSet":"2021-05-31T19:49:50.569Z"},{"_id":"60b5405054c6370022f93b81","songDataType":1,"playerID":"76561198035381239","songID":"FD34B0279836820254C31552C5753291ACBCBB95","songDifficulty":"expertplus","songName":"Climax","songArtist":"USAO","songMapper":"Timbo","songSpeed":1,"songStartTime":0,"songDuration":155.532,"trackers":{"hitTracker":{"leftNoteHit":753,"rightNoteHit":843,"bombHit":0,"maxCombo":366,"nbOfWallHit":0,"miss":7,"missedNotes":6,"badCuts":1,"leftMiss":3,"leftBadCuts":1,"rightMiss":3,"rightBadCuts":0},"accuracyTracker":{"accRight":106.078293,"accLeft":106.257637,"averageAcc":106.16291,"leftSpeed":35.65233,"rightSpeed":41.25209,"averageSpeed":38.610096,"leftHighestSpeed":65.26793,"rightHighestSpeed":60.5643539,"leftPreswing":1.24334085,"rightPreswing":1.255408,"averagePreswing":1.24971473,"leftPostswing":1.62315011,"rightPostswing":1.598779,"averagePostswing":1.61027741,"leftTimeDependence":0.22495842,"rightTimeDependence":0.2612874,"averageTimeDependence":0.244147226,"leftAverageCut":[69.16069,7.33864546,29.7583],"rightAverageCut":[68.77936,7.72479248,29.57414],"averageCut":[68.9592743,7.54260635,29.6610279],"gridAcc":[104.123291,107.059525,106.343224,105.253731,105.130432,111.285713,107,105.602341,107.240509,105.488235,106.84906,106.147057],"gridCut":[73,252,236,67,161,7,6,171,158,170,159,136]},"scoreTracker":{"rawScore":1327747,"score":1327747,"personalBest":1322192,"rawRatio":0.904758751,"modifiedRatio":0.904758751,"personalBestRawRatio":0.900973439,"personalBestModifiedRatio":0.900973439,"modifiersMultiplier":1,"modifiers":[]},"winTracker":{"won":true,"rank":"SS","endTime":155.337158,"nbOfPause":0},"distanceTracker":{"rightSaber":886.831238,"leftSaber":3325.281,"rightHand":886.831238,"leftHand":810.194031},"scoreGraphTracker":{"graph":{"2":0.9652174,"7":0.956521749,"8":0.9603122,"9":0.9580132,"10":0.9537167,"11":0.9500705,"12":0.949130058,"13":0.9435356,"14":0.941507936,"15":0.9426322,"16":0.941858947,"17":0.9412668,"18":0.9414779,"19":0.941177368,"20":0.9406934,"21":0.9398852,"22":0.9390343,"23":0.938095152,"24":0.937328458,"25":0.9329552,"26":0.9272454,"27":0.9220114,"28":0.9166814,"29":0.9116176,"30":0.910073042,"31":0.906534,"32":0.903594136,"33":0.900854766,"34":0.898230255,"35":0.895910442,"36":0.8974172,"37":0.8986285,"38":0.900026,"39":0.901402831,"40":0.902584434,"41":0.9033543,"42":0.904146969,"43":0.9028049,"44":0.9010154,"45":0.8991258,"46":0.8974228,"47":0.895685434,"48":0.8958748,"49":0.8963516,"50":0.8969544,"51":0.897563,"52":0.898086846,"53":0.898600042,"54":0.89917773,"55":0.8997257,"56":0.900255,"57":0.9009321,"58":0.9015769,"59":0.902150035,"60":0.9012838,"61":0.900349855,"62":0.8992429,"63":0.89810437,"64":0.8968873,"65":0.897083759,"66":0.896415532,"67":0.895484746,"68":0.8943981,"69":0.893391132,"70":0.892453253,"71":0.8924294,"72":0.8926991,"73":0.8930625,"74":0.893461049,"75":0.893812954,"76":0.894138753,"77":0.8944672,"78":0.894860446,"79":0.8953041,"80":0.8958025,"81":0.896321833,"82":0.8968401,"83":0.8973497,"84":0.897786,"85":0.898174644,"86":0.898462,"87":0.8987141,"88":0.8989692,"89":0.899228752,"90":0.8994996,"91":0.899839342,"92":0.900161,"93":0.900510967,"94":0.9007996,"95":0.9009997,"96":0.90121007,"97":0.9014674,"98":0.9016985,"99":0.901992,"100":0.902349651,"101":0.902682662,"102":0.902195036,"103":0.9017315,"104":0.9012266,"105":0.9007511,"106":0.900242448,"107":0.9005278,"108":0.9006476,"109":0.9007968,"110":0.90093416,"111":0.901147068,"112":0.901391,"113":0.9017854,"114":0.9021826,"115":0.9025466,"116":0.902843237,"117":0.90315187,"118":0.9034321,"119":0.903372765,"120":0.903290331,"121":0.903169632,"122":0.9030873,"123":0.9029704,"124":0.902483463,"125":0.902006149,"126":0.901566,"127":0.901074052,"128":0.9006251,"129":0.9008099,"130":0.901003838,"131":0.9012077,"132":0.90137887,"133":0.901534557,"134":0.9017107,"135":0.901907563,"136":0.9020669,"137":0.9022594,"138":0.9024308,"139":0.9025791,"140":0.902642131,"141":0.902720749,"142":0.9027628,"143":0.9027883,"144":0.9028823,"145":0.903038859,"146":0.903206646,"147":0.903368056,"148":0.903582156,"149":0.9037546,"150":0.903910339,"151":0.9040827,"152":0.9042924,"153":0.9044396,"154":0.9045653}}},"deepTrackers":null,"timeSet":"2021-05-31T20:00:16.534Z"},{"_id":"60b5449c54c6370022f93f7e","songDataType":1,"playerID":"76561198035381239","songID":"021541A8AB91C708724D5BDF28AF5E5C24213992","songDifficulty":"expertplus","songName":"Yggdrasil","songArtist":"Brothers of Metal","songMapper":"Meldi","songSpeed":1,"songStartTime":0,"songDuration":270.892,"trackers":{"hitTracker":{"leftNoteHit":603,"rightNoteHit":609,"bombHit":0,"maxCombo":1212,"nbOfWallHit":0,"miss":0,"missedNotes":0,"badCuts":0,"leftMiss":0,"leftBadCuts":0,"rightMiss":0,"rightBadCuts":0},"accuracyTracker":{"accRight":110.177338,"accLeft":108.907127,"averageAcc":109.54538,"leftSpeed":25.7512627,"rightSpeed":27.9960232,"averageSpeed":26.8792,"leftHighestSpeed":41.0510063,"rightHighestSpeed":54.5341644,"leftPreswing":1.37423027,"rightPreswing":1.39689922,"averagePreswing":1.38562083,"leftPostswing":2.09656763,"rightPostswing":2.13837719,"averagePostswing":2.117576,"leftTimeDependence":0.211959675,"rightTimeDependence":0.2398512,"averageTimeDependence":0.225974485,"leftAverageCut":[69.81426,9.092869,30],"rightAverageCut":[69.77668,10.4006567,30],"averageCut":[69.79538,9.75,30],"gridAcc":[108.239433,110.927536,110.139305,108.090912,108.441559,110.722221,109.058823,109.121948,109.777779,108.699028,110.317757,109.58],"gridCut":[71,207,201,66,154,18,17,164,54,103,107,50]},"scoreTracker":{"rawScore":1055253,"score":1055253,"personalBest":1050209,"rawRatio":0.9525707,"modifiedRatio":0.9525707,"personalBestRawRatio":0.9480175,"personalBestModifiedRatio":0.9480175,"modifiersMultiplier":1,"modifiers":[]},"winTracker":{"won":true,"rank":"SS","endTime":270.6958,"nbOfPause":0},"distanceTracker":{"rightSaber":981.000061,"leftSaber":3641.516,"rightHand":981.000061,"leftHand":953.476868},"scoreGraphTracker":{"graph":{"2":1,"3":0.9739131,"4":0.9668737,"5":0.9649512,"6":0.9642744,"7":0.955809653,"8":0.9579011,"9":0.9584867,"10":0.957170546,"11":0.9555945,"12":0.9548893,"13":0.954491556,"14":0.954393864,"15":0.95507133,"16":0.955827057,"17":0.956449747,"18":0.956697345,"19":0.9571473,"20":0.9574639,"21":0.9576038,"22":0.95786804,"23":0.9577802,"24":0.9574805,"25":0.9569783,"26":0.956318259,"27":0.9555876,"28":0.9552838,"29":0.9553726,"30":0.955852,"31":0.9563948,"32":0.9568435,"33":0.957160354,"34":0.95738554,"35":0.9573999,"36":0.957505167,"37":0.9577051,"38":0.9579286,"39":0.9577815,"40":0.957755446,"41":0.957690537,"42":0.9576816,"43":0.9577528,"44":0.9580079,"45":0.958089352,"46":0.9579149,"47":0.9577915,"48":0.9576005,"49":0.9575819,"50":0.9576131,"51":0.957835853,"52":0.957999349,"53":0.958123,"54":0.958095253,"55":0.958038,"56":0.957939565,"57":0.9577439,"58":0.9575812,"59":0.9575182,"60":0.9575231,"61":0.9575556,"62":0.9576831,"63":0.957765937,"64":0.9578178,"65":0.957875,"66":0.957857251,"67":0.9577263,"68":0.9576179,"69":0.9575502,"70":0.9574828,"71":0.9574382,"72":0.957476854,"73":0.9575208,"74":0.9574734,"75":0.957452238,"76":0.957430363,"79":0.957388,"80":0.9574292,"81":0.957566,"82":0.9575711,"83":0.9576291,"84":0.9576057,"85":0.9574983,"86":0.957382262,"87":0.957388461,"88":0.957399666,"89":0.9574957,"90":0.9576577,"91":0.957724631,"92":0.957774,"93":0.957826734,"94":0.9579423,"95":0.958026946,"96":0.9580967,"97":0.958135247,"98":0.9581598,"99":0.9581235,"100":0.958079,"101":0.9581553,"102":0.9582604,"103":0.958384633,"104":0.958506942,"105":0.9585725,"106":0.95860374,"107":0.9585902,"108":0.9585978,"109":0.958592057,"110":0.958622,"111":0.9586757,"112":0.9587624,"113":0.9588224,"114":0.9588644,"115":0.9588769,"116":0.958873,"117":0.9587989,"118":0.958728,"119":0.9586081,"120":0.9584719,"121":0.9583135,"122":0.9581981,"123":0.958053648,"124":0.957968,"125":0.9579115,"126":0.9578859,"127":0.9579086,"128":0.957945347,"129":0.957942843,"130":0.9579468,"131":0.957912445,"132":0.957843244,"133":0.957799554,"134":0.957811832,"135":0.957790256,"136":0.957758367,"137":0.957767963,"138":0.957747638,"139":0.9577072,"140":0.957696736,"141":0.9577347,"142":0.95773077,"143":0.9577379,"144":0.957727253,"145":0.9577117,"146":0.9576694,"147":0.957616448,"148":0.9575723,"149":0.9575546,"150":0.957549,"151":0.9575543,"152":0.9575541,"153":0.957578361,"154":0.9575801,"155":0.9575644,"156":0.957576454,"157":0.9576068,"158":0.957617939,"159":0.957664847,"160":0.9577169,"161":0.957737446,"162":0.95771575,"163":0.957672954,"164":0.957617342,"165":0.9575696,"166":0.9575341,"167":0.957542837,"168":0.9575812,"169":0.957627654,"170":0.9576439,"171":0.9576204,"172":0.957563,"173":0.957454145,"175":0.957345247,"176":0.957265437,"178":0.9571994,"179":0.957160056,"180":0.957152069,"181":0.957162738,"182":0.957186639,"183":0.957227349,"184":0.9572858,"185":0.957366645,"186":0.9574166,"187":0.9574745,"188":0.957532346,"189":0.9575493,"190":0.9574917,"191":0.957392454,"192":0.957212269,"193":0.9570223,"194":0.956864238,"195":0.9567392,"196":0.956680655,"197":0.956679463,"198":0.9566682,"199":0.956669152,"200":0.956687331,"201":0.956704855,"202":0.9567077,"203":0.9567176,"204":0.9566981,"205":0.9566564,"206":0.9565542,"207":0.9564491,"208":0.9563727,"209":0.9562515,"210":0.9561257,"211":0.956030965,"212":0.955957,"213":0.955848753,"214":0.95576334,"215":0.9557192,"216":0.9556661,"217":0.9556245,"218":0.955587149,"219":0.9555562,"220":0.9555162,"221":0.9555199,"222":0.9555032,"223":0.9554913,"224":0.9554945,"225":0.9554987,"226":0.9554748,"227":0.955437541,"228":0.9554218,"229":0.955420434,"230":0.955418468,"231":0.955441833,"232":0.9554955,"233":0.9555207,"234":0.955556154,"235":0.9556039,"236":0.9556178,"237":0.9556058,"238":0.955614567,"239":0.9555783,"240":0.9555418,"241":0.955522358,"242":0.9554969,"243":0.955464661,"244":0.9554634,"245":0.9554503,"246":0.9554131,"247":0.9553865,"248":0.95534116,"249":0.955265045,"250":0.9551861,"251":0.955117762,"252":0.955024242,"253":0.9549543,"254":0.954883933,"255":0.9547867,"256":0.95468,"257":0.9544842,"258":0.9542458,"259":0.953995764,"260":0.9537372,"261":0.953498542,"262":0.9533679,"263":0.953237355,"264":0.953109264,"265":0.952976763,"266":0.9528452,"267":0.9527164}}},"deepTrackers":null,"timeSet":"2021-05-31T20:18:36.443Z"},{"_id":"60b6931f685172002245e2fd","songDataType":1,"playerID":"76561198035381239","songID":"91288CA5FCDA1AF6C36623EF260291F64FEEDA93","songDifficulty":"expertplus","songName":"Dream of Winds","songArtist":"XeoN","songMapper":"Mystikmol","songSpeed":1,"songStartTime":0,"songDuration":113.778,"trackers":{"hitTracker":{"leftNoteHit":409,"rightNoteHit":410,"bombHit":0,"maxCombo":501,"nbOfWallHit":0,"miss":15,"missedNotes":10,"badCuts":5,"leftMiss":6,"leftBadCuts":1,"rightMiss":4,"rightBadCuts":4},"accuracyTracker":{"accRight":108.380486,"accLeft":107.486549,"averageAcc":107.934067,"leftSpeed":38.60382,"rightSpeed":41.8223648,"averageSpeed":40.2150574,"leftHighestSpeed":75.9001541,"rightHighestSpeed":77.2783,"leftPreswing":1.35157263,"rightPreswing":1.34251487,"averagePreswing":1.34703827,"leftPostswing":1.95946777,"rightPostswing":1.92515242,"averagePostswing":1.94228923,"leftTimeDependence":0.1708745,"rightTimeDependence":0.264607638,"averageTimeDependence":0.2177983,"leftAverageCut":[69.24205,8.246943,29.9975548],"rightAverageCut":[69.0390244,9.378049,29.9634151],"averageCut":[69.14041,8.813187,29.9804649],"gridAcc":[108.333336,108.57209,107.913795,104.6,106.56881,109.5,112,107.920357,110.724136,106,108.083336,107.931038],"gridCut":[21,215,232,20,109,4,5,113,29,18,24,29]},"scoreTracker":{"rawScore":663891,"score":663891,"personalBest":0,"rawRatio":0.8735006,"modifiedRatio":0.8735006,"personalBestRawRatio":0,"personalBestModifiedRatio":0,"modifiersMultiplier":1,"modifiers":[]},"winTracker":{"won":true,"rank":"S","endTime":113.5896,"nbOfPause":0},"distanceTracker":{"rightSaber":579.289734,"leftSaber":2366.90674,"rightHand":579.289734,"leftHand":588.0111},"scoreGraphTracker":{"graph":{"2":0.9652174,"3":0.960000038,"4":0.954342842,"5":0.9505666,"6":0.9524558,"7":0.9502927,"8":0.950579643,"9":0.953793,"10":0.958352268,"11":0.958849,"12":0.959857345,"13":0.959964752,"14":0.9591992,"15":0.95768553,"16":0.9556105,"17":0.9537786,"18":0.952808738,"19":0.9518031,"20":0.9508683,"21":0.950458467,"22":0.950445831,"23":0.949911,"24":0.949692,"25":0.949354947,"26":0.9488166,"27":0.948050737,"28":0.947228134,"29":0.9462847,"30":0.9454224,"31":0.944236338,"32":0.943243444,"33":0.9425227,"34":0.9417464,"35":0.9408081,"36":0.9403151,"37":0.9397641,"38":0.939092457,"39":0.938426733,"40":0.9379995,"41":0.9376192,"42":0.9373415,"43":0.937259734,"45":0.9374471,"46":0.937644362,"47":0.937857866,"48":0.9380421,"49":0.9381966,"50":0.938378453,"51":0.9386515,"52":0.938894,"53":0.9391163,"54":0.9393296,"55":0.9394653,"56":0.9395745,"57":0.939734161,"58":0.939914346,"59":0.9399473,"60":0.939930439,"61":0.9399002,"62":0.9398535,"63":0.9398186,"64":0.939910352,"65":0.9400725,"66":0.940252542,"67":0.94045186,"68":0.940628946,"69":0.940694749,"70":0.94074297,"71":0.9407376,"72":0.9391637,"73":0.937382936,"74":0.935684,"75":0.933033049,"76":0.9297572,"77":0.927975535,"78":0.926335752,"79":0.924709857,"80":0.921093762,"81":0.9163274,"82":0.911325634,"83":0.90591085,"84":0.8989722,"85":0.892905056,"86":0.8883481,"87":0.883501768,"88":0.8772567,"89":0.871986032,"90":0.8690148,"91":0.8665649,"92":0.86487776,"93":0.865286052,"94":0.8665295,"95":0.867724359,"96":0.8688217,"97":0.869880736,"98":0.870904744,"99":0.871062934,"100":0.870827854,"101":0.870572567,"102":0.8702956,"103":0.8700142,"104":0.870396137,"105":0.8710969,"106":0.87179637}}},"deepTrackers":null,"timeSet":"2021-06-01T20:05:51.686Z"},{"_id":"60b697d4685172002245e739","songDataType":1,"playerID":"76561198035381239","songID":"8B0954E826D02175872F9D80BF8BB96DE5A1B227","songDifficulty":"expertplus","songName":"THE LAUNCH OF THE MEGANTO METEOR","songArtist":"Camellia","songMapper":"Kuurama & miitchel & ExUnReal","songSpeed":1,"songStartTime":0,"songDuration":134.056,"trackers":{"hitTracker":{"leftNoteHit":422,"rightNoteHit":500,"bombHit":0,"maxCombo":339,"nbOfWallHit":0,"miss":3,"missedNotes":2,"badCuts":1,"leftMiss":2,"leftBadCuts":1,"rightMiss":0,"rightBadCuts":0},"accuracyTracker":{"accRight":107.174,"accLeft":106.720383,"averageAcc":106.966377,"leftSpeed":34.9477348,"rightSpeed":41.5226479,"averageSpeed":38.5133057,"leftHighestSpeed":70.92619,"rightHighestSpeed":90.04386,"leftPreswing":1.20952272,"rightPreswing":1.26930785,"averagePreswing":1.24194419,"leftPostswing":1.74443889,"rightPostswing":1.81389809,"averagePostswing":1.78210664,"leftTimeDependence":0.188808873,"rightTimeDependence":0.3062486,"averageTimeDependence":0.252496362,"leftAverageCut":[68.72038,8.28199,29.71801],"rightAverageCut":[68.744,8.556,29.874],"averageCut":[68.73319,8.430585,29.8026028],"gridAcc":[105.321426,107.329117,106.741173,104.717949,105.178574,109.933334,106.666664,106.972221,108.2,107.4,109.3,107.556961],"gridCut":[28,158,170,39,112,15,12,144,75,40,50,79]},"scoreTracker":{"rawScore":773836,"score":773836,"personalBest":768636,"rawRatio":0.9171335,"modifiedRatio":0.9171335,"personalBestRawRatio":0.9109706,"personalBestModifiedRatio":0.9109706,"modifiersMultiplier":1,"modifiers":[]},"winTracker":{"won":true,"rank":"SS","endTime":133.861084,"nbOfPause":0},"distanceTracker":{"rightSaber":561.684143,"leftSaber":1861.4093,"rightHand":561.684143,"leftHand":475.1147},"scoreGraphTracker":{"graph":{"2":0.991304338,"8":0.930434763,"9":0.9235942,"13":0.928546131,"17":0.9320924,"20":0.9225174,"21":0.93596673,"23":0.942097664,"24":0.9407156,"31":0.938722134,"37":0.9377585,"38":0.938417852,"39":0.938996851,"40":0.9404803,"41":0.9425337,"42":0.944117248,"43":0.944259942,"44":0.944096,"45":0.94397223,"46":0.94342047,"47":0.9431914,"48":0.944240451,"49":0.94469887,"50":0.9451916,"51":0.945548832,"52":0.9455357,"53":0.9454047,"54":0.945591331,"55":0.9456422,"56":0.9456854,"57":0.945987761,"58":0.9463938,"59":0.9466999,"60":0.9472088,"61":0.9479298,"62":0.948488533,"63":0.9489837,"64":0.9496393,"65":0.9501049,"66":0.950283647,"67":0.9504278,"68":0.9504534,"69":0.9503067,"70":0.9501005,"71":0.9498918,"72":0.949804366,"73":0.9494822,"74":0.94922936,"75":0.948084235,"76":0.9434751,"77":0.938652635,"78":0.934178948,"79":0.929692864,"80":0.926196,"81":0.9262718,"82":0.9266002,"83":0.9269468,"84":0.927332342,"85":0.9277059,"86":0.9281586,"87":0.9285517,"88":0.9288612,"89":0.9291318,"90":0.929219842,"91":0.929246545,"92":0.9292034,"93":0.9285924,"94":0.926831365,"95":0.9252038,"96":0.923635662,"97":0.921987534,"98":0.921014547,"99":0.9211503,"100":0.9212699,"101":0.9214332,"102":0.9216457,"103":0.921671,"104":0.9216476,"105":0.9216424,"106":0.9216326,"107":0.9216979,"108":0.921777964,"109":0.9220002,"110":0.92223,"111":0.9224086,"112":0.922447264,"113":0.9224145,"114":0.9211704,"115":0.9198926,"116":0.918626547,"117":0.9174546,"118":0.9164091,"119":0.916591465,"120":0.9167753,"121":0.9169169,"122":0.917042255,"123":0.9173174,"124":0.9175204,"125":0.9177491,"126":0.9178443,"127":0.9178574}}},"deepTrackers":null,"timeSet":"2021-06-01T20:25:56.329Z"},{"_id":"60b6988a685172002245e7d9","songDataType":1,"playerID":"76561198035381239","songID":"F6DC653A9FED9EEDF12C55163E508FDE404736B7","songDifficulty":"expertplus","songName":"Ghost Family Living In Graveyard","songArtist":"Roughsketch","songMapper":"Helloiamdaan & miitchel","songSpeed":1,"songStartTime":0,"songDuration":131.16,"trackers":{"hitTracker":{"leftNoteHit":560,"rightNoteHit":603,"bombHit":0,"maxCombo":551,"nbOfWallHit":0,"miss":2,"missedNotes":2,"badCuts":0,"leftMiss":2,"leftBadCuts":0,"rightMiss":0,"rightBadCuts":0},"accuracyTracker":{"accRight":108.610283,"accLeft":107.85,"averageAcc":108.244194,"leftSpeed":37.21585,"rightSpeed":44.29946,"averageSpeed":40.88861,"leftHighestSpeed":68.7903,"rightHighestSpeed":75.60164,"leftPreswing":1.33208561,"rightPreswing":1.36072683,"averagePreswing":1.34693563,"leftPostswing":1.71010053,"rightPostswing":1.7546978,"averagePostswing":1.73322356,"leftTimeDependence":0.184496939,"rightTimeDependence":0.294032961,"averageTimeDependence":0.241289914,"leftAverageCut":[69.5,8.701786,29.6482143],"rightAverageCut":[69.40133,9.426203,29.782753],"averageCut":[69.44884,9.077387,29.71797],"gridAcc":[106.1875,109.81,109.835,107.113205,105.425,113,110.5,106.714287,108.507576,108.676056,107.515625,108.539566],"gridCut":[48,200,200,53,120,1,2,133,132,71,64,139]},"scoreTracker":{"rawScore":994026,"score":994026,"personalBest":980684,"rawRatio":0.9337479,"modifiedRatio":0.9337479,"personalBestRawRatio":0.921214938,"personalBestModifiedRatio":0.921214938,"modifiersMultiplier":1,"modifiers":[]},"winTracker":{"won":true,"rank":"SS","endTime":130.963379,"nbOfPause":0},"distanceTracker":{"rightSaber":718.489136,"leftSaber":2729.92383,"rightHand":718.489136,"leftHand":688.7565},"scoreGraphTracker":{"graph":{"2":0.991304338,"3":0.983277559,"4":0.9813155,"5":0.979914665,"6":0.979452133,"7":0.975302637,"8":0.9757651,"9":0.9754212,"10":0.974432,"11":0.9723152,"12":0.9698366,"13":0.965695,"14":0.9611823,"15":0.957326353,"16":0.954319656,"17":0.953003645,"18":0.951985061,"19":0.95105505,"20":0.9502813,"21":0.949263155,"22":0.9484419,"23":0.947678864,"24":0.9475611,"25":0.9477546,"26":0.9478019,"27":0.947318554,"28":0.9466039,"29":0.946122,"30":0.9456676,"31":0.94558847,"32":0.9456583,"33":0.9458675,"34":0.9460143,"35":0.945982337,"36":0.945834,"37":0.9460129,"38":0.9463919,"39":0.9466081,"40":0.9467441,"41":0.9469143,"42":0.947057068,"43":0.947019458,"44":0.9468355,"45":0.946786642,"46":0.9468094,"47":0.9467059,"48":0.9465876,"49":0.946594656,"50":0.94646585,"51":0.9461605,"52":0.9458869,"53":0.9456829,"54":0.9454579,"55":0.945357859,"56":0.9453204,"57":0.9452114,"58":0.944986463,"59":0.9446647,"60":0.9442884,"61":0.943398356,"62":0.941558,"64":0.9398156,"65":0.9382465,"66":0.9367188,"67":0.9357675,"68":0.93589884,"69":0.935990751,"70":0.9360806,"71":0.936186552,"72":0.936299741,"73":0.9364351,"74":0.9365975,"75":0.936794937,"76":0.936939061,"77":0.9370618,"78":0.9371968,"80":0.937329531,"81":0.9373689,"82":0.937376,"83":0.9373583,"84":0.937332869,"85":0.9372624,"86":0.9372945,"87":0.9374511,"88":0.9376698,"89":0.9374579,"90":0.936482847,"91":0.9354832,"92":0.9344343,"93":0.933353364,"94":0.9326808,"95":0.9328006,"96":0.932933033,"97":0.9330197,"98":0.9332017,"99":0.933428466,"100":0.933702648,"101":0.9338871,"102":0.9341125,"103":0.934224248,"104":0.934352636,"105":0.9343065,"106":0.9342469,"107":0.934202731,"108":0.9341747,"109":0.934055567,"110":0.934016168,"111":0.9340055,"112":0.9339907,"113":0.9339616,"114":0.9339525,"115":0.933971345,"116":0.934007168,"117":0.933968246,"118":0.934002638,"119":0.9340877,"120":0.9342436,"121":0.9343373,"122":0.934532,"123":0.934661269,"124":0.9347741,"125":0.9348049,"126":0.9349083,"127":0.934878,"128":0.9347552,"129":0.9345135}}},"deepTrackers":null,"timeSet":"2021-06-01T20:28:58.981Z"},{"_id":"60b69c82685172002245eb30","songDataType":1,"playerID":"76561198035381239","songID":"BCD465BC14CD421901CEC7869800AB977918E091","songDifficulty":"expertplus","songName":"UMMU","songArtist":"t+pazolite","songMapper":"carrot","songSpeed":1,"songStartTime":0,"songDuration":127.582,"trackers":{"hitTracker":{"leftNoteHit":510,"rightNoteHit":586,"bombHit":0,"maxCombo":518,"nbOfWallHit":0,"miss":11,"missedNotes":10,"badCuts":1,"leftMiss":6,"leftBadCuts":0,"rightMiss":4,"rightBadCuts":1},"accuracyTracker":{"accRight":107.325935,"accLeft":106.903923,"averageAcc":107.129562,"leftSpeed":33.5737267,"rightSpeed":38.4798737,"averageSpeed":36.1969032,"leftHighestSpeed":54.86811,"rightHighestSpeed":65.09592,"leftPreswing":1.25022972,"rightPreswing":1.252924,"averagePreswing":1.25167024,"leftPostswing":1.6625005,"rightPostswing":1.65986824,"averagePostswing":1.66109312,"leftTimeDependence":0.206793547,"rightTimeDependence":0.2883463,"averageTimeDependence":0.250397474,"leftAverageCut":[69.19804,8.060784,29.6450977],"rightAverageCut":[69.05461,8.677474,29.5938568],"averageCut":[69.12135,8.390511,29.6177],"gridAcc":[105.542374,109.212769,108.994652,104.022224,106.123459,"NaN",97,106.256828,107.578949,103.84314,107.377052,106.125],"gridCut":[59,188,187,45,162,0,1,183,95,51,61,64]},"scoreTracker":{"rawScore":899657,"score":899657,"personalBest":0,"rawRatio":0.889696836,"modifiedRatio":0.889696836,"personalBestRawRatio":0,"personalBestModifiedRatio":0,"modifiersMultiplier":1,"modifiers":[]},"winTracker":{"won":true,"rank":"S","endTime":127.394287,"nbOfPause":0},"distanceTracker":{"rightSaber":672.354,"leftSaber":2477.783,"rightHand":672.354,"leftHand":613.8829},"scoreGraphTracker":{"graph":{"2":1,"3":0.9725218,"4":0.9614239,"5":0.9584556,"6":0.957148135,"7":0.946828842,"8":0.9466759,"9":0.9481063,"10":0.9472907,"11":0.9459124,"12":0.945646,"13":0.9453687,"14":0.943904161,"15":0.941769,"16":0.9401395,"17":0.9384318,"18":0.937336,"19":0.937245,"20":0.937908649,"21":0.938240051,"22":0.9359573,"23":0.931525,"24":0.927020133,"25":0.922956944,"26":0.9189561,"27":0.9173577,"28":0.9180443,"29":0.9186863,"30":0.9190037,"31":0.9193184,"32":0.9197088,"33":0.9202997,"34":0.920868456,"35":0.9213676,"36":0.9217803,"37":0.9204897,"38":0.9178664,"39":0.9152373,"40":0.9079066,"41":0.898660839,"42":0.8911136,"43":0.885059953,"44":0.879171848,"45":0.8761988,"46":0.875325739,"47":0.8745233,"48":0.8738464,"49":0.8731708,"50":0.8746613,"51":0.876181,"52":0.8770538,"53":0.8749841,"54":0.872575164,"55":0.8701321,"56":0.8676897,"57":0.865709245,"58":0.866548359,"59":0.867771864,"60":0.86894244,"61":0.869955361,"62":0.869620144,"63":0.8692982,"64":0.868952453,"65":0.868570745,"66":0.868177235,"67":0.869200945,"68":0.8700552,"69":0.870782435,"70":0.8713175,"71":0.8719484,"72":0.8725813,"73":0.8732425,"74":0.8738859,"75":0.8747415,"76":0.8754484,"77":0.876105249,"78":0.876693845,"79":0.877271831,"80":0.8777375,"81":0.8782643,"82":0.878769,"83":0.8792793,"84":0.879757941,"85":0.880260766,"86":0.880754769,"87":0.8813267,"88":0.8819081,"89":0.882507741,"90":0.8830164,"91":0.8835835,"92":0.884063661,"93":0.8845417,"94":0.88499254,"95":0.8855057,"96":0.8859483,"97":0.886423945,"98":0.8869814,"99":0.8874917,"100":0.8879801,"101":0.8884791,"102":0.8890182,"103":0.889479041,"104":0.889989138,"105":0.8905539,"106":0.8911026,"107":0.891595,"108":0.8920584,"109":0.892520547,"110":0.8929718,"111":0.893397,"112":0.893838346,"113":0.8942295,"114":0.8946239,"115":0.894909441,"116":0.895224154,"117":0.89554745,"118":0.895930469,"119":0.8962396,"120":0.89531374}}},"deepTrackers":null,"timeSet":"2021-06-01T20:45:54.266Z"}];
    const cacheData = async (playerId, data) => {
        // console.log(playerId, data);

        await beatSaviorPlayersRepository().set({playerId, lastRefresh: new Date()})

        return true;
    }

    const fetchPlayer = async (playerId, signal, priority) => {
        try {
            const data = queue.BEATSAVIOR.player(playerId, signal, priority);
            if (!data) {
                return false;
            }

            return cacheData(playerId, data);
        } catch (err) {
            log.warn(`Error fetching Beat Savior data for player "${playerId}"`);

            return false;
        }
    }

    const refresh = async (playerId, forceUpdate = false, signal = null, priority = PRIORITY.FG_LOW) => {
        const bsPlayerInfo = await beatSaviorPlayersRepository().get(playerId);
        if (bsPlayerInfo && bsPlayerInfo.lastRefresh > addToDate(-MAIN_PLAYER_REFRESH_INTERVAL)) return true;

        return cacheData(playerId, cache)

        if (cache && !forceUpdate) return true;

        return fetchPlayer(playerId, signal, priority)
    }

    const get = (playerId, leaderboardId) => {
        // TODO:

        return null;
    }

    return {
        refresh,
        get
    }
}